name: Wöchentliche Abhängigkeitsaktualisierung (pip + manifest)

on:
  schedule:
    # GitHub cron ist UTC. Zwei Zeiten decken CET/CEST ab und wir gardern zur lokalen Zeit 05:00 Europe/Berlin.
    - cron: '0 3 * * 5' # Freitags 03:00 UTC (05:00 CET)
    - cron: '0 4 * * 5' # Freitags 04:00 UTC (05:00 CEST)
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Repository auschecken
        uses: actions/checkout@v5

      - name: Zeitgesteuerte Ausführung (nur 05:00 Europa/Berlin)
        id: timecheck
        run: |
          HOUR=$(TZ=Europe/Berlin date +'%H')
          echo "Lokale Uhrzeit in Europa/Berlin: $HOUR"
          if [ "$HOUR" = "05" ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

      - name: Python einrichten
        uses: actions/setup-python@v6
        with:
          python-version: '3.13.2'
        if: steps.timecheck.outputs.should_run == 'true'

      - name: Requirements aktualisieren (nur patch/minor)
        if: steps.timecheck.outputs.should_run == 'true'
        id: update-deps
        run: |
          python .github/scripts/update_requirements.py

          # Prüfe ob Home Assistant aktualisiert wurde
          if git diff --quiet requirements_test.txt; then
            echo "ha_updated=false" >> $GITHUB_OUTPUT
            echo "homeassistant_version=" >> $GITHUB_OUTPUT
          else
            # Extrahiere neue HA-Version aus requirements_test.txt
            HA_VERSION=$(grep "^homeassistant" requirements_test.txt | sed 's/.*>= *//')
            echo "ha_updated=true" >> $GITHUB_OUTPUT
            echo "homeassistant_version=$HA_VERSION" >> $GITHUB_OUTPUT
            echo "Home Assistant wird auf Version $HA_VERSION aktualisiert"
          fi

      - name: Pull Request erstellen
        if: steps.timecheck.outputs.should_run == 'true'
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.WORKFLOW_PAT }}
          commit-message: |
            deps: wöchentliche Abhängigkeitsaktualisierungen (patch/minor)
          title: "deps: wöchentliche Abhängigkeitsaktualisierungen (patch/minor)"
          body: |
            Automatisierte wöchentliche Abhängigkeitsaktualisierung für pip-Requirements und manifest.
            - Wendet nur patch/minor Updates an
            - Überspringt Major-Updates und Major-Updates sensibler Pakete
            - Berücksichtigt pytest-homeassistant-custom-component Abhängigkeitsketten

            ${{ steps.update-deps.outputs.ha_updated == 'true' && format('## Home Assistant Update{0}{0}**Neue Version:** {1}{0}{0}**Info:** Nach dem Merge wird automatisch ein Kompatibilitätstest mit dieser HA-Version ausgeführt.', fromJSON('"\n"'), steps.update-deps.outputs.homeassistant_version) || '' }}
          labels: dependencies, python
          branch: chore/weekly-deps-update
          delete-branch: true
