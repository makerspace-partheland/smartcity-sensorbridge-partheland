name: Setup Repository Labels

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  issues: write
  contents: read

jobs:
  ensure-labels:
    runs-on: ubuntu-latest
    steps:
      - name: Ensure default labels
        uses: actions/github-script@v7
        with:
          script: |
            const required = [
              { name: 'dependencies', color: '0366d6', description: 'Dependency updates' },
              { name: 'python', color: '2b67c6', description: 'Python related' },
              { name: 'github-actions', color: '6f42c1', description: 'CI/CD updates' },
              { name: 'home-assistant', color: '00aaff', description: 'Home Assistant related' },
              { name: 'breaking-changes', color: 'd73a4a', description: 'Breaking changes detected' }
            ];

            async function upsert(label) {
              try {
                await github.rest.issues.getLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: label.name,
                });
                await github.rest.issues.updateLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: label.name,
                  color: label.color,
                  description: label.description,
                });
                core.info(`Updated label: ${label.name}`);
              } catch (e) {
                await github.rest.issues.createLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: label.name,
                  color: label.color,
                  description: label.description,
                });
                core.info(`Created label: ${label.name}`);
              }
            }

            for (const lbl of required) {
              await upsert(lbl);
            }

