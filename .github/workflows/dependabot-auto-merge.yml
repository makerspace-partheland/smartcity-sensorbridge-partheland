name: Dependabot Auto-Genehmigung & Auto-Merge (Patch)

on:
  pull_request_target:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write

jobs:
  automerge:
    if: github.actor == 'dependabot[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Repository auschecken
        uses: actions/checkout@v5

      - name: Dependabot Metadaten abrufen
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Dependabot Metadaten validieren
        id: validate-deps
        run: |
          # Validiere Update-Typ (nur patch)
          if ! echo "${{ steps.metadata.outputs.update-type }}" | grep -q "version-update:semver-patch"; then
            echo "Kein Patch-Update - Auto-Merge übersprungen"
            echo "valid_update=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Validiere kritische Pakete
          DEPS="${{ steps.metadata.outputs.dependencies }}"
          if echo "$DEPS" | grep -q "homeassistant\|paho-mqtt\|aiohttp"; then
            echo "Kritisches Paket erkannt - Auto-Merge übersprungen"
            echo "valid_update=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Dependabot Update ist für Auto-Merge geeignet"
          echo "valid_update=true" >> $GITHUB_OUTPUT

      - name: Auto-Merge aktivieren
        if: steps.validate-deps.outputs.valid_update == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          
          echo "Aktiviere Auto-Merge für PR #${PR_NUMBER}..."
          gh pr merge ${PR_NUMBER} \
            --auto \
            --squash \
            --delete-branch \
            --body "Automatisch zusammengeführt nach erfolgreichen Required Checks." \
            --subject "deps: Dependabot Patch-Update (automatisch)"
          
          echo "Auto-Merge für PR #${PR_NUMBER} aktiviert"
